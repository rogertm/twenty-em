<?php
/**
 * Twenty'em WordPress Framework.
 *
 * WARNING: This file is part of Twenty'em WordPress Framework.
 * DO NOT edit this file under any circumstances. Do all your modifications in the form of a child theme.
 *
 * @package			WordPress
 * @subpackage		Twenty'em
 * @author			RogerTM
 * @license			license.txt
 * @link			https://themingisprose.com/twenty-em
 * @since 			Twenty'em 1.2
 */


if ( ! function_exists( 't_em_header_image' ) ) :
/**
 * Pluggable Function: Display header image if it's set by the user in 'Header Options' admin panel
 *
 * @since Twenty'em 1.0
 */
function t_em_header_image(){
	global $post, $t_em;
	if ( ( 'header-image' == $t_em['header_set'] )
		&& ( ( '1' == $t_em['header_featured_image_home_only'] && is_home() )
		|| ( '0' == $t_em['header_featured_image_home_only'] ) ) ) :

		$header_image = get_header_image();
		if ( $header_image ) :
			$header_image_width = get_theme_support( 'custom-header', 'width' );
			$header_image_height = get_theme_support( 'custom-header', 'height' );
?>
		<section id="header-image">
		<?php
		/**
		 * Fires before the header image section. Full width;
		 *
		 * @since Twenty'em 1.1
		 */
		do_action( 't_em_action_header_image_before' );
		?>
			<div id="header-image-inner" class="<?php t_em_container(); ?>">
		<?php
		/**
		 * Fires in and before the header image section. Container width;
		 *
		 * @since Twenty'em 1.1
		 */
		do_action( 't_em_action_header_image_inner_before' );
		?>
					<a href="<?php echo esc_url( home_url( '/' ) ); ?>">
<?php
			// Check if the user choose to display featured image in single posts and pages
			if ( '1' == $t_em['header_featured_image'] &&
				// Check if this is a post or page and there is a thumbnail to show
				is_singular() && has_post_thumbnail( $post->ID ) &&
					( /* $src, $width, $height */ $image = wp_get_attachment_image_src( get_post_thumbnail_id( $post->ID ), array( $header_image_width, $header_image_width ) ) ) &&
					$image[1] >= $header_image_width ) :
					// Havana, we have a new header image :P
					// If the user set to true to display featured image in posts and page, then display it
					echo get_the_post_thumbnail( $post->ID, 'post-thumbnail' );
			else :
				$header_image_width = get_custom_header()->width;
				$header_image_height = get_custom_header()->height;
?>
						<img src="<?php header_image() ?>" width="<?php echo $header_image_width; ?>" height="<?php echo $header_image_height; ?>" alt="" />
<?php
			endif;
?>
					</a>
		<?php
		/**
		 * Fires in and after the header image section. Container width;
		 *
		 * @since Twenty'em 1.1
		 */
		do_action( 't_em_action_header_image_inner_after' );
		?>
			</div><!-- #header-image-inner -->
		<?php
		/**
		 * Fires after the header image section. Full width;
		 *
		 * @since Twenty'em 1.1
		 */
		do_action( 't_em_action_header_image_after' );
		?>
		</section><!-- #header-image -->
<?php
		endif;
	endif;
}
endif; // function t_em_header_image()
add_action( 't_em_action_header', 't_em_header_image', 5 );

if ( ! function_exists( 't_em_slider_bootstrap_carousel' ) ) :
/**
 * Pluggable Function: Display Bootstrap carousel of featured posts if it's set by the user in
 * 'Header Options > Slider' admin panel
 *
 * @param $args array Query arguments
 *
 * @since Twenty'em 1.0
 */
function t_em_slider_bootstrap_carousel( $args ){
	global	$post, $t_em;
	if ( ( 'slider' == $t_em['header_set'] )
		&& ( ( '1' == $t_em['slider_home_only'] && is_home() )
		|| ( '0' == $t_em['slider_home_only'] ) ) ) :

		if ( ! $args ) $args = t_em_slider_query_args();

			$slider_posts = get_posts( $args );
			$slider_wrap = ( $t_em['bootstrap_carousel_wrap'] == '1' ) ? 'false' : 'true';
			$slider_pause = ( $t_em['bootstrap_carousel_pause'] == '1' ) ? 'hover' : 'false';
	?>
			<section id="slider-carousel" class="carousel slide <?php t_em_container(); ?>" data-ride="carousel" data-wrap="<?php echo $slider_wrap; ?>" data-pause="<?php echo $slider_pause; ?>" data-interval="<?php echo $t_em['bootstrap_carousel_interval'] ?>">
			<?php
			/**
			 * Fires before the slider carousel section. Full width;
			 *
			 * @since Twenty'em 1.1
			 */
			do_action( 't_em_action_slider_before' );
			?>
<?php 		if ( $slider_posts ) : ?>
<?php 			$tp = count( $slider_posts ) ?>
				<ol class="carousel-indicators">
			<?php $s = 0; while ( $s < $tp ) : ?>
					<li data-target="#slider-carousel" data-slide-to="<?php echo $s ?>"></li>
			<?php $s++; endwhile; ?>
				</ol><!-- .carousel-indicators -->
				<div class="carousel-inner">
				<?php
				/**
				 * Fires in and before the slider carousel section. Container width;
				 *
				 * @since Twenty'em 1.1
				 */
				do_action( 't_em_action_slider_inner_before' );
				?>
				<?php foreach ( $slider_posts as $post ) : setup_postdata( $post );
					$thumbnail = t_em_image_resize( 1200, $t_em['slider_height'], $post->ID ); ?>
					<div class="carousel-item">
						<?php t_em_featured_post_thumbnail( 1200, $t_em['slider_height'], false, 'd-block w-100', $post->ID ); ?>
						<div id="<?php echo $post->post_name ?>-<?php echo $post->ID; ?>" class="carousel-caption">
							<h3 class="item-title">
								<a href="<?php the_permalink(); ?>" title="<?php printf( esc_attr__( 'Permalink to %s', 't_em' ), the_title_attribute( 'echo=0' ) ); ?>" rel="bookmark"><?php echo get_the_title(); ?></a>
							</h3>
							<div class="item-summary d-none d-md-block"><?php echo get_the_excerpt(); ?></div>
						</div>
					</div><!-- .item -->
				<?php endforeach; wp_reset_postdata(); ?>
				<?php
				/**
				 * Fires in and after the slider carousel section. Container width;
				 *
				 * @since Twenty'em 1.1
				 */
				do_action( 't_em_action_slider_inner_after' );
				?>
				</div><!-- .carousel-inner -->
				<a class="carousel-control-prev" href="#slider-carousel" role="button" data-slide="prev">
					<span class="carousel-control-prev-icon" aria-hidden="true"></span>
					<span class="sr-only"><?php _e( 'Previous', 't_em' ); ?></span>
				</a>
				<a class="carousel-control-next" href="#slider-carousel" role="button" data-slide="next">
					<span class="carousel-control-next-icon" aria-hidden="true"></span>
					<span class="sr-only"><?php _e( 'Next', 't_em' ) ?></span>
				</a>
<?php 	endif; ?>
		<?php
		/**
		 * Fires after the slider carousel section. Full width;
		 *
		 * @since Twenty'em 1.1
		 */
		do_action( 't_em_action_slider_after' );
		?>
	</section><!-- #slider-carousel -->
<?php
	endif;
}
endif; // function t_em_slider_bootstrap_carousel()
add_action( 't_em_action_header', 't_em_slider_bootstrap_carousel', 5 );

/**
 * Return arguments for slider query. Only post with images attached to it will be displayed
 *
 * @return array Query arguments
 *
 * @since Twenty'em 1.0
 */
function t_em_slider_query_args(){
	global $t_em;
	$cat_posts = get_posts( array( 'category' => $t_em['slider_category'], 'posts_per_page' => 99 ) );
	$i = 1;
	$p = array();
	foreach ( $cat_posts as $cp ) :
		$img = get_children( array( 'post_parent' => $cp->ID, 'post_type' => 'attachment', 'post_mime_type' => 'image' ) );
		if ( ! empty( $img ) ) :
			$tp = $cp->ID;
			array_push( $p, $tp );
		endif;
	endforeach;
	$tp = count( $p );
	$lp = $tp - $t_em['slider_number'];
	while ( $i <= $lp ) :
		array_pop( $p );
		$i++;
	endwhile;
	$tp = count( $p );

	$args = array(
		'post_type'			=> 'post',
		'cat'				=> $t_em['slider_category'],
		'post__in'			=> $p,
		'posts_per_page'	=> $tp,
		'orderby'			=> 'date',
		'order'				=> 'DESC',
	);

	/**
	 * Filter the Slider query arguments
	 *
	 * @param array $args An array of arguments
	 * @link http://codex.wordpress.org/Class_Reference/WP_Query
	 * @since Twenty'em 1.0
	 */
	return apply_filters( 't_em_filter_slider_query_args', $args );
}

if ( ! function_exists( 't_em_static_header' ) ) :
/**
 * Pluggable Function: Display Static Header if it's set by the user in
 * 'Header Options > Static Header' admin panel
 *
 * @since Twenty'em 1.0
 */
function t_em_static_header(){
	global $t_em;
	if ( ( 'static-header' == $t_em['header_set'] )
		&& ( ( '1' == $t_em['static_header_home_only'] && is_home() )
		|| ( '0' == $t_em['static_header_home_only'] ) ) ) :
?>
		<section id="static-header" class="jumbotron <?php echo $t_em['static_header_text'] ?>" role="info">
			<div class="<?php t_em_container(); ?>">
			<?php
			/**
			 * Fires before the static header section. Full width;
			 *
			 * @since Twenty'em 1.1
			 */
			do_action( 't_em_action_static_header_before' );
			?>
				<div id="static-header-inner" class="row">
			<?php
			/**
			 * Fires in and before the static header section. Full width;
			 *
			 * @since Twenty'em 1.1
			 */
			do_action( 't_em_action_static_header_inner_before' );
			?>
	<?php 	if ( ! empty ( $t_em['static_header_img_src'] ) ) : ?>
				<div id="static-header-image" <?php t_em_add_bootstrap_class( 'static-header' ); ?>>
					<img src="<?php echo $t_em['static_header_img_src']; ?>"
						alt="<?php echo sanitize_text_field( $t_em['static_header_headline'] ); ?>">
				</div><!-- #static-header-image -->
	<?php 	endif; ?>

	<?php 	if ( $t_em['static_header_headline']
				|| $t_em['static_header_content']
				|| ( $t_em['static_header_primary_button_text'] && $t_em['static_header_primary_button_link'] )
				|| ( $t_em['static_header_secondary_button_text'] && $t_em['static_header_secondary_button_link'] )
			) : ?>
				<div id="static-header-text" <?php t_em_add_bootstrap_class( 'static-header' ); ?>>
	<?php 	if ( $t_em['static_header_headline'] ) : ?>
					<header><h2><?php echo $t_em['static_header_headline']; ?></h2></header>
	<?php 	endif; ?>
	<?php 	if ( $t_em['static_header_content'] ) : ?>
					<div class="static-header-content"><?php echo t_em_wrap_paragraph( $t_em['static_header_content'] ); ?></div>
	<?php 	endif; ?>
					<footer class="actions">
	<?php 	if ( ( $t_em['static_header_primary_button_text'] && $t_em['static_header_primary_button_link'] ) ) : ?>
						<a href="<?php echo $t_em['static_header_primary_button_link']; ?>"
							class="btn btn-primary">
								<span class="<?php echo $t_em['static_header_primary_button_icon_class'] ?> icomoon"></span>
								<span class="button-text"><?php echo $t_em['static_header_primary_button_text']; ?></span>
							</a>
	<?php 	endif; ?>
	<?php 	if ( ( $t_em['static_header_secondary_button_text'] && $t_em['static_header_secondary_button_link'] ) ) : ?>
						<a href="<?php echo $t_em['static_header_secondary_button_link']; ?>"
							class="btn btn-secondary">
								<span class="<?php echo $t_em['static_header_secondary_button_icon_class'] ?> icomoon"></span>
								<span class="button-text"><?php echo $t_em['static_header_secondary_button_text']; ?></span>
							</a>
	<?php 	endif; ?>
					</footer><!-- .actions -->
				</div><!-- #static-header-text -->
	<?php 	endif; ?>
			<?php
			/**
			 * Fires in and after the static header section. Full width;
			 *
			 * @since Twenty'em 1.1
			 */
			do_action( 't_em_action_static_header_inner_after' );
			?>
				</div>
			<?php
			/**
			 * Fires after the static header section. Full width;
			 *
			 * @since Twenty'em 1.1
			 */
			do_action( 't_em_action_static_header_after' );
			?>
			</div>
		</section><!-- #static-header .container -->
<?php
	endif;
}
endif; // function t_em_static_header()
add_action( 't_em_action_header', 't_em_static_header', 5 );
?>
