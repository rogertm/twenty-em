<?php
/**
 * Twenty'em WordPress Framework.
 *
 * WARNING: This file is part of Twenty'em WordPress Framework.
 * DO NOT edit this file under any circumstances. Do all your modifications in the form of a child theme.
 *
 * @package			WordPress
 * @subpackage		Twenty'em
 * @author			RogerTM
 * @license			license.txt
 * @link			https://themingisprose.com/twenty-em
 * @since 			Twenty'em 1.0
 */

/**
 * Check if it dependencies are installed and send an error on fail
 *
 * @since Twenty'em 1.4
 */
function t_em_check_dependencies(){
	$node	= T_EM_THEME_DIR_NODE_PATH;
	$dist 	= T_EM_THEME_DIR_ASSETS_DIST_PATH;

	if ( ! file_exists( $node ) || ! file_exists( $dist ) ) :
		$msg = __( '<h1>Oops!</h1>', 't_em' );
		$msg .= t_em_wrap_paragraph( __( 'It seems it\'s first time you run %s. To complete the installation you should run this from your CLI:', 't_em' ) );
		$msg .= t_em_wrap_paragraph( '<pre>$ cd %s <br>$ npm install <br>$ gulp deploy</pre>' );
		$msg .= t_em_wrap_paragraph( __( 'Search in the <a href="%s">documentation</a> for more details.' ) );

		$error = sprintf( $msg,
							T_EM_FRAMEWORK_NAME,
							T_EM_THEME_DIR_PATH,
							T_EM_WIKI
						);
		wp_die( $error, __( 'Oops!', 't_em' ) );
	endif;
}
add_filter( 'init', 't_em_check_dependencies' );

/**
 * Twenty'em Helpers Functions.
 */

/**
 * Helper. Register and Enqueue Bootstrap jQuery Plugins
 *
 * @param $plugin Required. String. Plugin name and extension (IE: transition)
 * @param $script Optional. String. Additional script if needed by the plugin
 * @param $script_src Optional. String. Required if $script, the $script source address
 * @param $deps Optional. Array. Array of the handles of all the registered scripts that this script depends on.
 * @param $transition Optional. Bool. Enqueue util.js Bootstrap plugin for simple transition effects
 * @param $in_footer Optional. Bool. If true, the script is placed before the </body> end tag
 *
 * @since Twenty'em 1.0
 */
function t_em_register_bootstrap_plugin( $plugin, $script = '', $script_src = '', $deps = array(), $util = true, $in_footer = true ){
	$deps = array_merge( $deps, array( 'jquery' ) );

	if ( WP_DEBUG ) :
		$handle = ( file_exists( T_EM_THEME_DIR_BOOTSTRAP_PATH .'/js/dist/'. $plugin .'.js' ) ) ? $plugin .'.js' : $plugin .'.min.js';
		$util = ( $util && file_exists( T_EM_THEME_DIR_BOOTSTRAP_PATH .'/js/dist/'. 'util.js' ) ) ? 'util.js' : 'util.min.js';
	else :
		$handle = ( file_exists( T_EM_THEME_DIR_BOOTSTRAP_PATH .'/js/dist/'. $plugin .'.min.js' ) ) ? $plugin .'.min.js' : $plugin .'.js';
		$util = ( $util && file_exists( T_EM_THEME_DIR_BOOTSTRAP_PATH .'/js/dist/'. 'util.min.js' ) ) ? 'util.min.js' : 'util.js';
	endif;

	if ( $util ) :
		array_push( $deps, $util );
		wp_register_script( $util, T_EM_THEME_DIR_BOOTSTRAP_URL.'/js/dist/'. $util, array( 'jquery' ), t_em_theme( 'Version' ), $in_footer );
	endif;

	wp_register_script( $handle, T_EM_THEME_DIR_BOOTSTRAP_URL .'/js/dist/'. $handle, $deps, t_em_theme( 'Version' ), $in_footer );
	wp_enqueue_script( $handle );
	if ( $script ) :
		wp_register_script( $script, $script_src, array( 'jquery' ), t_em_theme( 'Version' ), $in_footer );
		wp_enqueue_script( $script );
	endif;
}

/**
 * Get javascript files
 * This functions loads minify scripts if the site is running online, otherwise (WP_DEBUG == true),
 * loads the beautify script.
 * @param string $handle 	Script handle. If the file is named my.script.min.js, $handle = 'my.script'
 * 							Both files should exists: my.script.min.js and my.script.js
 * @param string $path  	File path. If is a child theme set this parameter to T_EM_CHILD_THEME_DIR_PATH .'/path/to/js-dir/'
 * @param string $url  		File URL. If is a child theme set this parameter to T_EM_CHILD_THEME_DIR_URL .'/url/to/js-dir/'
 * @return string  			File URL. False if file does not exist
 *
 * @since Twenty'em 1.2
 */
function t_em_get_js( $handle, $path = T_EM_THEME_DIR_JS_PATH, $url = T_EM_THEME_DIR_JS_URL ){
	if ( WP_DEBUG ) :
		$file = ( file_exists( $path .'/'. $handle .'.js' ) ) ? $handle .'.js' : $handle .'.min.js';
	else :
		$file = ( file_exists( $path .'/'. $handle .'.min.js' ) ) ? $handle .'.min.js' : $handle .'.js';
	endif;
	if ( file_exists( $path .'/'. $file ) ) :
		$file_url = $url .'/'. $file;
		return $file_url;
	endif;
	return false;
}

/**
 * Get css files
 * This functions loads minify css file if the site is running online, otherwise (WP_DEBUG == true),
 * loads the beautify css.
 * @param string $handle 	Script handle. If the file is named my.css.min.js, $handle = 'my.css'
 * 							Both files should exists: my.css.min.js and my.css.js
 * @param string $path  	File path. If is a child theme set this parameter to T_EM_CHILD_THEME_DIR_PATH .'/path/to/css-dir/'
 * @param string $url  		File URL. If is a child theme set this parameter to T_EM_CHILD_THEME_DIR_URL .'/url/to/css-dir/'
 * @return string  			File URL. False if file does not exist
 *
 * @since Twenty'em 1.2
 */
function t_em_get_css( $handle, $path = T_EM_THEME_DIR_CSS_PATH, $url = T_EM_THEME_DIR_CSS_URL ){
	if ( WP_DEBUG ) :
		$file = ( file_exists( $path .'/'. $handle .'.css' ) ) ? $handle .'.css' : $handle .'.min.css';
	else :
		$file = ( file_exists( $path .'/'. $handle .'.min.css' ) ) ? $handle .'.min.css' : $handle .'.css';
	endif;
	if ( file_exists( $path .'/'. $file ) ) :
		$file_url = $url .'/'. $file;
		return $file_url;
	endif;
	return false;
}

/**
 * Add Bootstrap CSS Classes dynamically.
 *
 * @param string $section Required. The name of the section that Bootstrap CSS Classes are needed.
 *
 * @since Twenty'em 1.0
 */
function t_em_breakpoint( $section ){
	$breakpoint = array();

	/** Main Content, Content, Sidebar and Sidebar Alt */
	$layout_set = t_em( 'layout_set' );
	$one_column = in_array( $layout_set, array( 'one-column' ) );
	$two_column = in_array( $layout_set,
						array( 'two-columns-content-right',
							   'two-columns-content-left' ) );
	$three_column = in_array( $layout_set,
						array( 'three-columns-content-left',
							   'three-columns-content-right',
							   'three-columns-content-middle' ) );

	// #main-content
	if ( 'main-content' == $section ) :
		$breakpoint[] = 'row';
	endif;
	// #content and three-column or one-column
	if ( 'content' == $section && $three_column ) :
		$breakpoint[] = t_em_grid( '6' );
	elseif ( 'content' == $section && $one_column ) :
		$breakpoint[] = t_em_grid( '12' );
	endif;
	// #content && #main-content One column templates
	if ( 'content-one-column' == $section ) :
		$breakpoint[] = t_em_grid( '12' );
		$breakpoint[] = 'one-column';
	endif;
	// #sidebar and three-column
	if ( 'sidebar' == $section && $three_column ) :
		$breakpoint[] = t_em_grid( '3' );
		$breakpoint[] = 'widget-area';
	endif;
	// #sidebar-alt and three-column
	if ( 'sidebar-alt' == $section && $three_column ) :
		$breakpoint[] = t_em_grid( '3' );
		$breakpoint[] = 'widget-area';
	endif;
	// #content and two-column
	if ( 'content' == $section && $two_column && ! ( is_home() && t_em( 'front_page_set' ) != 'wp-front-page' ) ) :
		$breakpoint[] = t_em_grid( '8' );
	endif;
	// #content and !front_page_set['wp-front-page']
	if ( 'content' == $section && is_front_page() && t_em( 'front_page_set' ) != 'wp-front-page' ) :
		$breakpoint[] = t_em_grid( '12' );
	endif;
	// #sidebar and two-column
	if ( 'sidebar' == $section && $two_column ) :
		$breakpoint[] = t_em_grid( '4' );
		$breakpoint[] = 'widget-area';
	endif;

	/** Static Header Content and Image */
	if ( 'static-header' == $section ) :
		$static_header_img = ( ! empty ( t_em( 'static_header_img_src' ) ) ) ? '1' : '0';
		$static_header_content = ( ! empty ( t_em( 'static_header_headline' ) )
								|| ! empty ( t_em( 'static_header_content' ) )
								|| ! empty ( t_em( 'static_header_primary_button_text' ) )
								|| ! empty ( t_em( 'static_header_secondary_button_text' ) )
								) ? '1' : '0';
		$total_static_header = array_sum( array( $static_header_img, $static_header_content ) );
		$cols = 12 / $total_static_header;
		$breakpoint[] = t_em_grid( $cols );
	endif;

	/** Front Page Widgets Area */
	if ( 'primary-featured-widget-area' == $section ) :
		$breakpoint[] = t_em_grid( '12', 'md' );
	endif;
	// Classes are needed for secondaries widgets only (two, three and four).
	if ( 'secondary-featured-widget-area' == $section ) :
		$widget_two		= ( ! empty ( t_em( 'headline_text_widget_two' ) ) || ! empty ( t_em( 'content_text_widget_two' ) ) ) ? '1' : '0' ;
		$widget_three	= ( ! empty ( t_em( 'headline_text_widget_three' ) ) || ! empty ( t_em( 'content_text_widget_three' ) ) ) ? '1' : '0' ;
		$widget_four	= ( ! empty ( t_em( 'headline_text_widget_four' ) ) || ! empty ( t_em( 'content_text_widget_four' ) ) ) ? '1' : '0' ;
		$total_widgets = array_sum( array( $widget_two, $widget_three, $widget_four ) );
		$cols = 12 / $total_widgets;
		$breakpoint[] = t_em_grid( $cols, 'md' );
	endif;

	/** Footer Widgets Area */
	if ( 'footer-widget-area' == $section ) :
		$one_widget_footer = ( 'no-footer-widget' != t_em( 'footer_set' ) ) ? '1' : '0';
		$two_widget_footer = ( in_array( t_em( 'footer_set' ),
								array( 'two-footer-widget', 'three-footer-widget', 'four-footer-widget' )
							 ) ) ? '1' : '0';
		$three_widget_footer = ( in_array( t_em( 'footer_set' ),
									array( 'three-footer-widget', 'four-footer-widget' )
								 ) ) ? '1' : '0';
		$four_widget_footer = ( in_array( t_em( 'footer_set' ),
									array( 'four-footer-widget' )
								 ) ) ? '1' : '0';
		$total_widgets = array_sum( array( $one_widget_footer, $two_widget_footer, $three_widget_footer, $four_widget_footer ) );
		$cols = 12 / $total_widgets;
		$breakpoint[] = t_em_grid( $cols );
	endif;

	/**
	 * Filter the list of CSS Bootstrap classes on the current template.
	 * The dynamic portion of the hook name, "$section", refers to the parameter $section where this
	 * functions is called.
	 *
	 * @param array Bootstrap CSS classes
	 * @since Twenty'em 1.0
	 */
	$classes = apply_filters( "t_em_filter_breakpoint_{$section}", $breakpoint );
	$classes = array_unique( $classes );
	echo 'class="' . implode( ' ', $classes ) . '"';
}

/**
 * Grid breakpoint
 * @param string $cols 			Columns
 * @param string $breakpoint 	Breakpoint. Default 'lg'
 * @param boolean $offset 		Offset. If 'true' columns will be offset. Default 'false'
 * @return string 				CSS class. 'col-$breakpoint-$cols' or 'offset-$breakpoint-$cols' if
 * 								$offset is set to true
 *
 * @since Twenty'em 1.2
 * @since Twenty'em 1.4.0		Added parameter $offset
 */
function t_em_grid( $cols, $breakpoint = '', $offset = false ){
	/**
	 * Filter the default breakpoint
	 * @param string $breakpoint	Default breakpoint
	 *
	 * @since Twenty'em 1.2
	 */
	$bp = ( ! $breakpoint ) ? apply_filters( 't_em_filter_default_breakpoint', 'lg' ) : $breakpoint;
	$sep = ( $bp ) ? '-' : null;
	$class = ( ( $offset ) ? 'offset-' : 'col-' ) . $bp . $sep . $cols;
	return $class;
}

/**
 * Container or Container Fluid, that's the meollo
 * @param bool 		$echo. Echo or return the result
 * @return string 	.container or .container-fluid class, set by the user in the admin panel Layout Options
 *
 * @since Twenty'em 1.2
 */
function t_em_container( $echo = true ){
	$container = ( t_em( 'layout_fluid_width' ) ) ? 'container-fluid' : 'container';
	if ( $echo )
		echo $container;
	else
		return $container;
}

/**
 * Display featured image in posts archives when "Display the Excerpt" option is
 * activated in admin theme option page.
 *
 * @param int $width Require Thumbnail width.
 * @param int $height Require Thumbnail height.
 * @param boolean $link Optional The image will be linkable or not. Default: true.
 * @param string $class Optional CSS class.
 * @param int $post_id Optional. Post ID. Default is ID of the global $post.
 *
 * @return string 			HTML "img" tag
 *
 * @since Twenty'em 1.0
 * @since Twenty'em 1.2		Deleted "figure" and "figcaption" wrapped element
 * @since Twenty'em 1.3.2	Show only the featured post thumbnail if exists
 */
function t_em_featured_post_thumbnail( $width, $height, $link = true, $class = null, $post_id = 0 ){
	$post_id = absint( $post_id );
	if ( ! $post_id )
		$post_id = get_the_ID();

	$attachment_id = get_post_thumbnail_id( $post_id );

	$open_link = ( $link ) ? '<a href="'. get_permalink( $post_id ) .'" rel="bookmark">' : null;
	$close_link = ( $link ) ? '</a>' : null;

	/**
	 * Filter default image to show if the current post has no image associated to it
	 * @param null $default_post_thumbnail. URL of the default post thumbnail
	 *
	 * @since Twenty'em 1.0
	 */
	$default_thumbnail = apply_filters( 't_em_filter_default_post_thumbnail', null );

	$thumbnail = ( t_em_image_resize( $width, $height, $attachment_id ) ) ? t_em_image_resize( $width, $height, $attachment_id ) : $default_thumbnail;

	if ( $thumbnail ) :
		echo $open_link; ?>
		<img class="featured-post-thumbnail <?php echo $class ?>" alt="<?php echo get_the_title( $post_id ); ?>" src="<?php echo $thumbnail ?>" width="<?php echo $width ?>" height="<?php echo $height ?>"/>
<?php 	echo $close_link;
	endif;
}

/**
 * Resize images on the fly
 *
 * @param int $width 			Required. New image width
 * @param int $height 			Required. New image height
 * @param int $attachment_id 	Required. Attachment ID
 * @param bool $crop Optional. 	Crop image. Default true
 *
 * @return string|null 			URL of the new image.
 *
 * @since Twenty'em 1.0
 * @since Twenty'em 1.3.2		Change parameter $post_id to $attachment_id
 */
function t_em_image_resize( $width, $height, $attachment_id, $crop = true ){
	$image_path = get_attached_file( $attachment_id );

	if ( ! $image_path )
		return;

	// Image data
	$image_url = wp_get_attachment_image_src( $attachment_id, 'full' );
	$image_src = $image_url[0]; // Original image
	$image_edit = wp_get_image_editor( $image_url[0] );
	$image_info = pathinfo( $image_path );

	// Image dimensions
	$image_size = getimagesize( $image_path );

	// If Width and Height are bigger than original size we use the original image
	if ( $width >= $image_size[0] && $height >= $image_size[1] ) :
		$image_thumbnail = $image_src;
	else :
		// Set dimensions
		$max_width = ( $width >= $image_size[0] ) ? $image_size[0] : $width;
		$max_height = ( $height >= $image_size[1] ) ? $image_size[1] : $height;

		// Image to be saved
		$image_to_save = $image_info['dirname'] .'/'. $image_info['filename'] .'-'. $max_width .'x'. $max_height .'.'. $image_info['extension'];

		// Create the new image
		if ( ! file_exists( $image_to_save ) ) :
			if ( ! is_wp_error( $image_edit ) ) :
				$image_edit->resize( $max_width, $max_height, $crop );
				$image_edit->save( $image_to_save );
			endif;
		endif;
		$image_thumbnail = str_replace( $image_info['filename'], $image_info['filename'] .'-'. $max_width .'x'. $max_height, $image_src );
	endif;
	return $image_thumbnail;
}

/**
 * Helper. Wrap paragraphs into <p> ...</p> tags, and clean empty lines
 * @param string $paragraph Require Paragraph to be wrapped into <p> ...</p> tags
 * @return string
 *
 * @since Twenty'em 1.0
 */
function t_em_wrap_paragraph( $paragraph ){
	$wrap_paragraph = explode( "\n", $paragraph );
	$i = 0;
	$ps = count($wrap_paragraph) - 1;
	while ( $i <= $ps ) :
		$p[$i] = "<p>" . $wrap_paragraph[$i] . "</p>";
		$clean_paragraph[$i] = str_replace( "<p>\r</p>", "", $p[$i] );
		$i++;
	endwhile;
	return implode( "", $clean_paragraph );
}

/**
 * Get the resume of every post
 * @param int $post_id 	Post ID. Default 0, the current post
 * @param bool $echo 	Return the value or print it on screen. Default to 'true'
 * @return string 		The 'post_excerpt' field or the first $trim words of the 'post_content' fields
 * 						if 'post_excerpt' is empty
 *
 * @since Twenty'em 1.2.2
 */
function t_em_get_post_excerpt( $post_id = 0, $echo = true ){
	global $post;

	$post_id = absint( $post_id );
	if ( ! $post_id )
		$post_id = $post->ID;

	$excerpt = get_post_field( 'post_excerpt', $post_id );
	$content = get_post_field( 'post_content', $post_id );
	$trim 	 = t_em( 'excerpt_length' );

	if ( ! empty( $excerpt ) ) :
		$resume = $excerpt;
	else :
		$resume = wp_trim_words( $content, $trim );
	endif;

	if ( $echo ) :
		echo strip_shortcodes( $resume );
	else :
		return strip_shortcodes( $resume );
	endif;
}
?>
